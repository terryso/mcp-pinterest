# Pinterest MCP Server - 架构文档

## 1. 系统概述

Pinterest MCP Server 是一个实现了 Model Context Protocol (MCP) 的服务器，专门为 AI 应用提供 Pinterest 图片搜索和下载功能。该服务器允许 MCP 客户端（如 IDE 插件、AI 工具、聊天界面等）通过标准化的接口与 Pinterest 交互，搜索相关图片、获取图片信息，以及下载所需图片到指定目录。

### 1.1 关键特性

*   基于 Model Context Protocol (MCP) 的标准化接口
*   无需 Pinterest 认证即可搜索公开内容
*   支持关键词搜索和批量下载
*   提供图片元数据信息获取
*   可集成到支持 MCP 的 AI 应用中

## 2. 技术栈

*   **语言**: TypeScript/JavaScript
*   **核心框架**: Model Context Protocol SDK (@modelcontextprotocol/sdk)
*   **依赖**:
    *   puppeteer-core: 无头浏览器，用于爬取 Pinterest 网站
    *   axios: HTTP 客户端，用于图片下载
    *   cheerio: HTML 解析库（可能用于提取图片信息）
*   **开发工具**: 
    *   TypeScript
    *   Jest (测试框架)
    *   ts-node-dev (开发时热重载)

## 3. 系统架构

### 3.1 组件架构

Pinterest MCP Server 采用模块化的架构设计，主要由以下组件构成：

```
┌────────────────────────────────────────┐
│           Pinterest MCP Server          │
│                                        │
│  ┌────────────┐       ┌──────────────┐ │       ┌─────────────┐
│  │   MCP      │       │  Pinterest   │ │       │             │
│  │  Server    │<─────>│   Scraper    │ │<─────>│  Pinterest  │
│  │ Interface  │       │              │ │       │  Website    │
│  └────────────┘       └──────────────┘ │       │             │
│         │                     │        │       └─────────────┘
│         │                     │        │
│         ▼                     ▼        │
│  ┌────────────┐       ┌──────────────┐ │       ┌─────────────┐
│  │            │       │   Image      │ │       │             │
│  │   Tools    │<─────>│  Download    │ │<─────>│   Local     │
│  │  Handler   │       │   Module     │ │       │ File System │
│  └────────────┘       └──────────────┘ │       │             │
│                                        │       └─────────────┘
└────────────────────────────────────────┘
```

#### 3.1.1 MCP 服务器接口

*   职责: 实现 MCP 协议，管理客户端连接，执行工具列表和工具调用的处理。
*   主要文件: `pinterest-mcp-server.ts`
*   主要类: `PinterestMcpServer`
*   功能:
    *   创建和配置 MCP 服务器实例
    *   处理 MCP 工具列表请求
    *   路由工具调用请求到相应的处理器
    *   错误处理和资源清理

#### 3.1.2 Pinterest 爬虫模块

*   职责: 与 Pinterest 网站交互，执行搜索查询，提取图片信息。
*   主要文件: `pinterest-scraper.js`
*   主要类: `PinterestScraper`
*   功能:
    *   启动和配置无头浏览器
    *   导航到 Pinterest 搜索页面
    *   提取和解析搜索结果
    *   自动滚动加载更多结果
    *   提取图片 URL 和元数据

#### 3.1.3 下载模块

*   职责: 下载图片到本地文件系统，管理文件名和目录结构。
*   主要文件: `src/pinterest-download.js`
*   主要函数: `downloadImage`，`batchDownload`
*   功能:
    *   确保目标目录存在
    *   从 URL 下载图片
    *   生成文件名和路径
    *   执行批量下载操作
    *   跟踪下载成功和失败的统计信息

#### 3.1.4 工具处理模块

*   职责: 处理特定工具的调用，转换参数，调用相应的功能模块，格式化返回结果。
*   主要文件: `pinterest-mcp-server.ts` 中的处理函数
*   主要方法: `handlePinterestSearch`，`handlePinterestGetImageInfo`，`handlePinterestSearchAndDownload`
*   功能:
    *   参数验证和规范化
    *   调用爬虫和下载模块
    *   错误处理和结果格式化
    *   返回符合 MCP 规范的响应

### 3.2 数据流

#### 3.2.1 搜索图片流程

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│  MCP       │    │ Tool       │    │ Pinterest  │    │ Pinterest  │    │ MCP        │
│  Client    │───>│ Handler    │───>│ Scraper    │───>│ Website    │───>│ Client     │
│ (请求搜索) │    │ (解析参数) │    │ (执行搜索) │    │ (返回结果) │    │ (收到结果) │
└────────────┘    └────────────┘    └────────────┘    └────────────┘    └────────────┘
```

1.  MCP 客户端调用 `pinterest_search` 工具，传入关键词和限制参数
2.  工具处理器解析和验证参数
3.  Pinterest 爬虫启动无头浏览器，导航到搜索页面
4.  爬虫提取搜索结果，包括图片 URL 和元数据
5.  结果返回给 MCP 客户端

#### 3.2.2 下载图片流程

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│  MCP       │    │ Tool       │    │ Pinterest  │    │ Download   │    │ MCP        │
│  Client    │───>│ Handler    │───>│ Scraper    │───>│ Module     │───>│ Client     │
│ (请求下载) │    │ (解析参数) │    │ (执行搜索) │    │ (下载图片) │    │ (收到结果) │
└────────────┘    └────────────┘    └────────────┘    └────────────┘    └────────────┘
```

1.  MCP 客户端调用 `pinterest_search_and_download` 工具
2.  工具处理器解析和验证参数
3.  Pinterest 爬虫执行搜索并返回结果
4.  下载模块将图片保存到目标目录
5.  下载结果（成功/失败统计）返回给 MCP 客户端

### 3.3 配置与常量

当前服务器使用以下硬编码的默认配置：

*   **DEFAULT_SEARCH_LIMIT**: 10（默认搜索结果数量）
*   **DEFAULT_SEARCH_KEYWORD**: 'landscape'（默认搜索关键词）
*   **DEFAULT_HEADLESS_MODE**: true（默认无头浏览器模式）
*   **DEFAULT_DOWNLOAD_DIR**: `path.join(__dirname, '../downloads')`（默认下载目录）
*   **文件命名格式**: `pinterest_{imageId}.{fileExtension}`

## 4. MCP 工具接口

服务器提供以下 MCP 工具：

### 4.1 pinterest_search

*   **描述**: 根据关键词在 Pinterest 上搜索图片
*   **输入参数**:
    *   `keyword`: 字符串 (必需) - 搜索关键词
    *   `limit`: 整数 (可选, 默认 10) - 返回的图片数量上限
    *   `headless`: 布尔值 (可选, 默认 true) - 是否使用无头浏览器模式
*   **输出**: 包含图片信息的对象数组（包括 ID、URL、标题等）

### 4.2 pinterest_get_image_info

*   **描述**: 获取 Pinterest 图片的详细信息
*   **输入参数**:
    *   `image_url`: 字符串 (必需) - 图片 URL
*   **输出**: 包含图片信息的对象（包括 URL、来源、时间戳）

### 4.3 pinterest_search_and_download

*   **描述**: 根据关键词搜索 Pinterest 图片并下载到服务器
*   **输入参数**:
    *   `keyword`: 字符串 (必需) - 搜索关键词
    *   `limit`: 整数 (可选, 默认 10) - 返回和下载的图片数量上限
    *   `headless`: 布尔值 (可选, 默认 true) - 是否使用无头浏览器模式
    *   `download_dir`: 字符串 (可选) - 下载目录路径 (当前未实际使用，固定使用 DEFAULT_DOWNLOAD_DIR)
*   **输出**: 下载操作的结果对象，包含成功/失败统计和详细信息

## 5. 计划中的高优先级功能

根据用户故事，以下功能已被确定为高优先级：

### 5.1 可配置下载目录 (US-Future-001)

*   **目标**: 让服务器管理员可以配置图片下载的目标目录
*   **实现方式**: 通过环境变量 `MCP_PINTEREST_DOWNLOAD_DIR` 设置
*   **行为**:
    *   服务器启动时检查环境变量是否存在
    *   如果存在，验证路径是否可用并有写入权限
    *   所有下载操作将使用此路径替代默认的 '../downloads'
    *   如果环境变量未设置，则使用默认路径
*   **架构影响**:
    *   需要修改下载模块和工具处理器
    *   在服务器初始化时读取和验证环境变量
    *   更新路径确定逻辑

### 5.2 自定义文件名模板 (US-Future-002)

*   **目标**: 让服务器管理员可以自定义下载文件的命名规则
*   **实现方式**: 通过环境变量 `MCP_PINTEREST_FILENAME_TEMPLATE` 设置
*   **行为**:
    *   服务器启动时检查环境变量是否存在
    *   如果存在，解析模板字符串并验证格式
    *   所有下载操作将使用此模板生成文件名
    *   支持的模板变量包括：
        *   `{imageId}`: Pinterest 图片 ID
        *   `{fileExtension}`: 图片文件扩展名
        *   `{timestamp}`: 下载时间戳
        *   `{index}`: 批量下载时的序号
    *   如果环境变量未设置，则使用默认模板 `pinterest_{imageId}.{fileExtension}`
*   **架构影响**:
    *   需要新增文件名生成模块或函数
    *   需要实现模板解析和变量替换逻辑
    *   需要确保生成的文件名在操作系统中合法

## 6. 部署架构

```
┌────────────────────────────────────────────────────────────┐
│                         Host System                         │
│                                                            │
│  ┌────────────────┐       ┌───────────────────────────┐   │
│  │                │       │                           │   │
│  │    MCP Host    │       │   Pinterest MCP Server    │   │
│  │                │       │                           │   │
│  │  (e.g. Claude  │◄─────►│  (Environment Variables   │   │
│  │    Desktop)    │       │   configuration)          │   │
│  │                │       │                           │   │
│  └────────────────┘       └───────────────┬───────────┘   │
│                                           │               │
│                                           ▼               │
│                           ┌───────────────────────────┐   │
│                           │                           │   │
│                           │     Downloaded Images     │   │
│                           │                           │   │
│                           │  (Configured by           │   │
│                           │   MCP_PINTEREST_DOWNLOAD_DIR) │   │
│                           │                           │   │
│                           └───────────────────────────┘   │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

## 7. 安全性考虑

### 7.1 当前限制

*   **无认证**: 当前版本不支持 Pinterest 用户认证，仅访问公开内容
*   **路径验证**: 在实现 US-Future-001 时需确保对环境变量指定的路径进行严格验证，防止路径遍历攻击
*   **文件名清理**: 在实现 US-Future-002 时需确保对生成的文件名进行清理，移除非法字符

### 7.2 改进机会

*   增加请求限流
*   添加文件大小限制
*   增加下载资源的 MIME 类型验证
*   考虑添加 API 密钥验证机制

## 8. 性能考虑

*   无头浏览器实例是资源密集型的，需要合理管理
*   图片下载应考虑超时和重试机制
*   批量并行下载可能比当前的顺序下载更高效
*   可考虑添加结果缓存，减少重复请求

## 9. 测试策略

项目当前具有测试基础架构(Jest)，应为新功能添加以下类型的测试：

*   单元测试：独立测试模板解析、路径验证等功能
*   集成测试：测试环境变量的读取和应用
*   模拟测试：避免在测试时实际访问 Pinterest 或文件系统

## 10. 总结

Pinterest MCP Server 采用模块化的架构设计，提供了通过 MCP 协议访问 Pinterest 图片的标准化接口。高优先级的改进计划（可配置下载目录和自定义文件名模板）将通过环境变量实现，使系统更具灵活性和可配置性，同时保持架构的整体性和安全性。 